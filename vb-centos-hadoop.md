# Virtual Box安装CentOS搭建Hadoop集群

## Virtual Box安装CentOS

| 工具                | 版本                             |
| ------------------- | -------------------------------- |
| cenos               | CentOS-6.8-x86_64-bin-DVD1.iso   |
| Virtual Box         | VirtualBox-6.1.4-136177-Win.exe  |
| Virtual Box增强工具 | VBoxGuestAdditions_6.1.0_RC1.iso |

### Virtual Box设置

内存分配1024M

硬盘选中“使用主机输入输出缓存”和“固态驱动器”

网卡使用双网卡，第一个“NAT”，第二个“Host-Only”

### centos 分区

1. /boot 200M
2. /swap 2G
3. / 15G

### 增强工具安装

为了共享粘贴板和鼠标不被虚拟机独占等功能，需要安装增强工具，首先需要给centos安装必要的工具：

```shel
yum  -y  install kernel kernel-devel make gcc*
```

这里我还执行了yum update

挂载增强工具镜像，安装工具这里踩了很多坑，如果实在安装不成功建议跳过，反正以后大部分时间都是使用工具远程连接，这里我用默认的包安装不成功，去下了另外一个才安装成功，下载地址：http://download.virtualbox.org/virtualbox/

挂载过程：

<img src="https://irmp.github.io/images/image-20200305122549765.png" alt="image-20200305122549765" style="zoom:80%;" />

挂载之后桌面会弹出自动运行提示，或者去/media下也可以手动安装，安装成功之后注意开启共享粘贴板等功能。

<img src="https://irmp.github.io/images/image-20200305122840915.png" alt="image-20200305122840915" style="zoom:70%;" />

我出现过安装不报错，但是功能不可用的情况，重启虚拟机，重启宿主机之后又莫名好了，建议这里不要花费太多时间，可以后面有空再回来安装。

### 网络配置

1./etc/sysconfig/network-scripts/ifcfg-eth0 文件内容：

```shell
DEVICE=eth0
TYPE=Ethernet
UUID=c31b74b5-3bdc-4077-9a49-4fcc6c1a30c0
ONBOOT=yes
NM_CONTROLLED=yes
BOOTPROTO=dhcp
DEFROUTE=yes
IPV4_FAILURE_FATAL=yes
IPV6INIT=no
NAME="System eth0"
HWADDR=08:00:27:18:b1:00
PEERDNS=yes
PEERROUTES=yes
LAST_CONNECT=1583335310
```

一般不用修改，注意ONBOOT是yes，BOOTPROTO是dhcp，该网卡用来连接外网

2./etc/sysconfig/network-scripts/ifcfg-eth1，没有这个文件就从ifcfg-eth0复制一份，内容：

```shell
DEVICE=eth1 #修改设备名称
TYPE=Ethernet
ONBOOT=yes
NM_CONTROLLED=yes
BOOTPROTO=static #修改为静态IP
DEFROUTE=yes
IPV4_FAILURE_FATAL=yes
IPV6INIT=no
NAME="System eth1" #修改网卡名称
IPADDR=192.168.56.11 #添加IP
HWADDR=08:00:27:8b:3b:25 #修改网卡MAC地址
PREFIX=24
UUID=9c92fad9-6ecb-3e6c-eb4d-8a47c6f50c04
LAST_CONNECT=1583377543
```

注意需要修改的几个地方

**IPADDR** 这个需要根据VBox设置去修改，设置-》主机网络管理器，设置成和IPv4地址同一个网段就可以了

<img src="https://irmp.github.io/images/image-20200305121458734.png" alt="image-20200305121458734" style="zoom: 80%;" />

**HWADDR**，网卡mac地址可以从虚拟机设置中获取：

<img src="https://irmp.github.io/images/image-20200305121724193.png" alt="image-20200305121724193" style="zoom:80%;" />

3.修改/etc/resolv.conf添加nameserver，没有就新建一个

```shell
# Generated by NetworkManager
domain Home
search Home
nameserver 192.168.1.1
```

nameserver 需要设置成自己宿主机的外网网关

4.修改主机名

/etc/sysconfig/network中修改HOSTNAME

```shell
NETWORKING=yes
HOSTNAME=hadoop01
NTPSERVERARGS=iburst
```

5.修改hosts文件，/etc/hosts中添加集群主机名和ip

修改后重启(reboot)，或者重启网络服务(service network restart) 

配置完成后虚拟机应该可以上网，宿主机使用xshell等工具连接虚拟机时连接192.168.56.11（eth1的ip），eth0的ip是动态分配的不用管。



## 克隆（复制）虚拟机

<img src="https://irmp.github.io/images/image-20200305124322293.png" alt="image-20200305124322293" style="zoom:70%;" />

选择为所有网卡重新生成MAC地址，下一步选择”完全复制“结束，启动新的虚拟机。

### 网络配置

首先，修改/etc/udev/rules.d/70-persistent-net.rules,

<img src="https://irmp.github.io/images/image-20200305125513402.png" alt="image-20200305125513402" style="zoom: 80%;" />

上面的eth0和eth1是复制过来的，下面的是这次新增的，通过attr{address}对照mac地址可以发现。

我们删除复制过来的，然后留下和新生成的mac地址一致的两个网卡，然后name分别改成eth0和eth1，修改后的文件内容：

```shell
# program, run by the persistent-net-generator.rules rules file.
#
# You can modify it, as long as you keep each rule on a single
# line, and change only the value of the NAME= key.

# PCI device 0x8086:0x100e (e1000)
SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*", ATTR{address}=="08:00:27:ae:aa:66", ATTR{type}=="1", KERNEL=="eth*", NAME="eth0"

# PCI device 0x8086:0x100e (e1000)
SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*", ATTR{address}=="08:00:27:9c:0e:91", ATTR{type}=="1", KERNEL=="eth*", NAME="eth1"
```

然后eth0不用管，需要修改eth1网卡的配置,vi /etc/sysconfig/network-scripts/ifcfg-eth1

```shell
DEVICE=eth1
TYPE=Ethernet
ONBOOT=yes
NM_CONTROLLED=yes
BOOTPROTO=static
DEFROUTE=yes
IPV4_FAILURE_FATAL=yes
IPV6INIT=no
NAME="System eth1"
IPADDR=192.168.56.12 #修改ip地址
HWADDR=08:00:27:9c:0e:91 #修改mac地址
PREFIX=24
UUID=9c92fad9-6ecb-3e6c-eb4d-8a47c6f50c04
LAST_CONNECT=1583377543
```

然后修改hostname，vi /etc/sysconfig/network

```shell
NETWORKING=yes
HOSTNAME=hadoop02
NTPSERVERARGS=iburst
```

补一个host文件，vi /etc/hosts

```shell
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
192.168.56.11 hadoop01
192.168.56.12 hadoop02
192.168.56.13 hadoop03
```

修改完成后直接reboot，克隆完成。

## 添加mr用户

```shell
useradd mr
passwd mr
su mr
```

sudo vi /etc/sudoers

```shell
## Allow root to run any commands anywhere
root    ALL=(ALL)       ALL
## add mr to sudoers
mr    ALL=(ALL)       ALL
```

创建module和software目录，修改所属用户和组

```shell
cd /opt
sudo mkdir module
sudo mkdir software
sudo chown mr@mr module/ software/
```

```shel
[mr@hadoop01 opt]$ ll
总用量 12
drwxr-xr-x. 2 mr   mr   4096 3月  10 10:26 module
drwxr-xr-x. 2 mr   mr   4096 3月  10 10:23 software
```

## 安装 jdk

upload[^xshell] jdk-8u144-linux-x64.tar.gz to /opt/software/

[^xshell]:https://irmp.github.io/xshell

```shell
tar -zxvf jdk-8u144-linux-x64.tar.gz -C /opt/module/
```

检查centos自带jdk，卸载之

```shell
[mr@hadoop01 jdk1.8.0_144]$ rpm -qa|grep java
java-1.5.0-gcj-1.5.0.0-29.1.el6.x86_64
java_cup-0.10k-5.el6.x86_64
gcc-java-4.4.7-23.el6.x86_64
[mr@hadoop01 jdk1.8.0_144]$ sudo yum -y remove java
```

设置环境变量

```shell
sudo vi /etc/profile
#add below to this file
##JAVA_HOME
export JAVA_HOME=/opt/module/jdk1.8.0_144
export PATH=$PATH:$JAVA_HOME/bin
```

验证

```shell
source /etc/profile
[mr@hadoop01 jdk1.8.0_144]$ java -version
java version "1.8.0_144"
Java(TM) SE Runtime Environment (build 1.8.0_144-b01)
Java HotSpot(TM) 64-Bit Server VM (build 25.144-b01, mixed mode)
```



## 安装hadoop

上传hadoop-2.7.2.tar.gz到/opt/software目录，解压到module目录

```shell
tar -zxvf hadoop-2.7.2.tar.gz -C /opt/module/
```

添加环境变量

```shell
sudo vi /etc/profile
#添加下面几行
##HADOOP_HOME
export HADOOP_HOME=/opt/module/hadoop-2.7.2
export PATH=$PATH:$HADOOP_HOME/bin
export PATH=$PATH:$HADOOP_HOME/sbin

#最后source让环境变量生效
source /etc/profile
```

验证

```shell
[mr@hadoop01 hadoop-2.7.2]$ hadoop
Usage: hadoop [--config confdir] [COMMAND | CLASSNAME]
  CLASSNAME            run the class named CLASSNAME
 or
  where COMMAND is one of:
  fs                   run a generic filesystem user client
  version              print the version
  jar <jar>            run a jar file
                       note: please use "yarn jar" to launch
                             YARN applications, not this command.
  checknative [-a|-h]  check native hadoop and compression libraries availability
  distcp <srcurl> <desturl> copy file or directories recursively
  archive -archiveName NAME -p <parent path> <src>* <dest> create a hadoop archive
  classpath            prints the class path needed to get the
  credential           interact with credential providers
                       Hadoop jar and the required libraries
  daemonlog            get/set the log level for each daemon
  trace                view and modify Hadoop tracing settings

Most commands print help when invoked w/o parameters.
```



## 运行单机版wordcount程序

在hadoop目录下，新建input目录，然后新建输入文件，输入一些单词

```shell
cd /opt/module/hadoop-2.7.2
mkdir input
vi input/wc.input
```

执行hadoop wordcount样例程序

```shell
hadoop jar share/hadoop/mapreduce/hadoop-mapreduce-examples-2.7.2.jar wordcount input output
```

查看结果

```shell
[mr@hadoop01 hadoop-2.7.2]$ cat output/part-r-00000 
gaoyang	2
huichao	1
lihua	1
tianyi	1
xiaoheng	1
xinbo	2
yanjing	1
zhangchen	1
```



## 伪分布式搭建

### 修改配置文件

- 修改etc/hadoop/core-site.xml

```xml
<configuration>
    <!-- 指定hdfs中namenode的地址-->
    <property>
        <name>fs.defaultFS</name>
        <value>hdfs://hadoop01:9000</value>
    </property>

    <!-- 指定haoop运行时产生文件的存储目录-->
    <property>
        <name>hadoop.tmp.dir</name>
        <value>/opt/module/hadoop-2.7.2/data/tmp</value>
    </property>
</configuration>
```

- 修改etc/hadoop/hadoop-env.sh

```shell
# The only required environment variable is JAVA_HOME.  All others are
# optional.  When running a distributed configuration it is best to
# set JAVA_HOME in this file, so that it is correctly defined on
# remote nodes.
# The java implementation to use.
export JAVA_HOME=/opt/module/jdk1.8.0_144
```

- 修改etc/hadoop/hdfs-site.xml，副本数改成1

```xml
<configuration>
    <property>
        <name>dfs.replication</name>
        <value>1</value>
    </property>
</configuration>
```

### 启动集群

- 格式化NameNode

```shel
hdfs namenode -format
```

- 启动NameNode

```shell
[mr@hadoop01 hadoop-2.7.2]$ sbin/hadoop-daemon.sh start namenode
starting namenode, logging to /opt/module/hadoop-2.7.2/logs/hadoop-mr-namenode-hadoop01.out
[mr@hadoop01 hadoop-2.7.2]$ jps
2688 Jps
2621 NameNode
```

- 启动DataNode

```shell
[mr@hadoop01 hadoop-2.7.2]$ sbin/hadoop-daemon.sh start datanode
starting datanode, logging to /opt/module/hadoop-2.7.2/logs/hadoop-mr-datanode-hadoop01.out
[mr@hadoop01 hadoop-2.7.2]$ jps
2711 DataNode
2621 NameNode
2782 Jps
```

- 查看web管理页面

http://hadoop01:50070/

这里需要关闭centos防火墙或开放50070端口

关闭方法：

```shell
#临时关闭
sudo /etc/init.d/iptables stop 
#永久关闭
sudo chkconfig iptables off
```

