# Virtual Box安装CentOS搭建Hadoop集群

## Virtual Box安装CentOS

| 工具                | 版本                             |
| ------------------- | -------------------------------- |
| cenos               | CentOS-6.8-x86_64-bin-DVD1.iso   |
| Virtual Box         | VirtualBox-6.1.4-136177-Win.exe  |
| Virtual Box增强工具 | VBoxGuestAdditions_6.1.0_RC1.iso |

### Virtual Box设置

内存分配1024M

硬盘选中“使用主机输入输出缓存”和“固态驱动器”

网卡使用双网卡，第一个“NAT”，第二个“Host-Only”

### centos 分区

1. /boot 200M
2. /swap 2G
3. / 15G

### 增强工具安装

为了共享粘贴板和鼠标不被虚拟机独占等功能，需要安装增强工具，首先需要给centos安装必要的工具：

```shel
yum  -y  install kernel kernel-devel make gcc*
```

这里我还执行了yum update

挂载增强工具镜像，安装工具这里踩了很多坑，如果实在安装不成功建议跳过，反正以后大部分时间都是使用工具远程连接，这里我用默认的包安装不成功，去下了另外一个才安装成功，下载地址：http://download.virtualbox.org/virtualbox/

挂载过程：

<img src="https://irmp.github.io/images/image-20200305122549765.png" alt="image-20200305122549765" style="zoom:80%;" />

挂载之后桌面会弹出自动运行提示，或者去/media下也可以手动安装，安装成功之后注意开启共享粘贴板等功能。

<img src="https://irmp.github.io/images/image-20200305122840915.png" alt="image-20200305122840915" style="zoom:70%;" />

我出现过安装不报错，但是功能不可用的情况，重启虚拟机，重启宿主机之后又莫名好了，建议这里不要花费太多时间，可以后面有空再回来安装。

### 网络配置

1./etc/sysconfig/network-scripts/ifcfg-eth0 文件内容：

```shell
DEVICE=eth0
TYPE=Ethernet
UUID=c31b74b5-3bdc-4077-9a49-4fcc6c1a30c0
ONBOOT=yes
NM_CONTROLLED=yes
BOOTPROTO=dhcp
DEFROUTE=yes
IPV4_FAILURE_FATAL=yes
IPV6INIT=no
NAME="System eth0"
HWADDR=08:00:27:18:b1:00
PEERDNS=yes
PEERROUTES=yes
LAST_CONNECT=1583335310
```

一般不用修改，注意ONBOOT是yes，BOOTPROTO是dhcp，该网卡用来连接外网

2./etc/sysconfig/network-scripts/ifcfg-eth1，没有这个文件就从ifcfg-eth0复制一份，内容：

```shell
DEVICE=eth1 #修改设备名称
TYPE=Ethernet
ONBOOT=yes
NM_CONTROLLED=yes
BOOTPROTO=static #修改为静态IP
DEFROUTE=yes
IPV4_FAILURE_FATAL=yes
IPV6INIT=no
NAME="System eth1" #修改网卡名称
IPADDR=192.168.56.11 #添加IP
HWADDR=08:00:27:8b:3b:25 #修改网卡MAC地址
PREFIX=24
UUID=9c92fad9-6ecb-3e6c-eb4d-8a47c6f50c04
LAST_CONNECT=1583377543
```

注意需要修改的几个地方

**IPADDR** 这个需要根据VBox设置去修改，设置-》主机网络管理器，设置成和IPv4地址同一个网段就可以了

<img src="https://irmp.github.io/images/image-20200305121458734.png" alt="image-20200305121458734" style="zoom: 80%;" />

**HWADDR**，网卡mac地址可以从虚拟机设置中获取：

<img src="https://irmp.github.io/images/image-20200305121724193.png" alt="image-20200305121724193" style="zoom:80%;" />

3.修改/etc/resolv.conf添加nameserver，没有就新建一个

```shell
# Generated by NetworkManager
domain Home
search Home
nameserver 192.168.1.1
```

nameserver 需要设置成自己宿主机的外网网关

4.修改主机名

/etc/sysconfig/network中修改HOSTNAME

```shell
NETWORKING=yes
HOSTNAME=hadoop01
NTPSERVERARGS=iburst
```

5.修改hosts文件，/etc/hosts中添加集群主机名和ip

修改后重启(reboot)，或者重启网络服务(service network restart) 

配置完成后虚拟机应该可以上网，宿主机使用xshell等工具连接虚拟机时连接192.168.56.11（eth1的ip），eth0的ip是动态分配的不用管。



## 克隆（复制）虚拟机

<img src="https://irmp.github.io/images/image-20200305124322293.png" alt="image-20200305124322293" style="zoom:70%;" />

选择为所有网卡重新生成MAC地址，下一步选择”完全复制“结束，启动新的虚拟机。

### 网络配置

首先，修改/etc/udev/rules.d/70-persistent-net.rules,

<img src="https://irmp.github.io/images/image-20200305125513402.png" alt="image-20200305125513402" style="zoom: 80%;" />

上面的eth0和eth1是复制过来的，下面的是这次新增的，通过attr对照mac地址可以发现。

我们删除复制过来的，然后留下和新生成的mac地址一致的两个网卡，然后name分别改成eth0和eth1，修改后的文件内容：

```shell
# program, run by the persistent-net-generator.rules rules file.
#
# You can modify it, as long as you keep each rule on a single
# line, and change only the value of the NAME= key.

# PCI device 0x8086:0x100e (e1000)
SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*", ATTR{address}=="08:00:27:ae:aa:66", ATTR{type}=="1", KERNEL=="eth*", NAME="eth0"

# PCI device 0x8086:0x100e (e1000)
SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*", ATTR{address}=="08:00:27:9c:0e:91", ATTR{type}=="1", KERNEL=="eth*", NAME="eth1"
```

然后eth0不用管，需要修改eth1网卡的配置,vi /etc/sysconfig/network-scripts/ifcfg-eth1

```shell
DEVICE=eth1
TYPE=Ethernet
ONBOOT=yes
NM_CONTROLLED=yes
BOOTPROTO=static
DEFROUTE=yes
IPV4_FAILURE_FATAL=yes
IPV6INIT=no
NAME="System eth1"
IPADDR=192.168.56.12 #修改ip地址
HWADDR=08:00:27:9c:0e:91 #修改mac地址
PREFIX=24
UUID=9c92fad9-6ecb-3e6c-eb4d-8a47c6f50c04
LAST_CONNECT=1583377543
```

然后修改hostname，vi /etc/sysconfig/network

```shell
NETWORKING=yes
HOSTNAME=hadoop02
NTPSERVERARGS=iburst
```

补一个host文件，vi /etc/hosts

```shell
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
192.168.56.11 hadoop01
192.168.56.12 hadoop02
192.168.56.13 hadoop03
```

修改完成后直接reboot，克隆完成。
